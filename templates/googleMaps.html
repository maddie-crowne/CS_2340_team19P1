{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Restaurants in Atlanta</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=geometry&callback=initMap"
            async defer></script>
    <script src="{% static 'favorites.js' %}"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 70%;
            width: 68%;
            margin-top: 0;
            transition: all 0.3s;
            float: left;
        }
        .title-bar {
            align-items: center;
            background-color: #043D49;
            max-height: 150px;
        }
        .header {
            color: white;
            text-align: center;
            font-size: 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-left: 15px;
            margin-right: 15px;
        }
        .logo-title {
            display: flex;
            margin-left: auto;
            margin-right: auto;
            align-items: center;
            justify-content: center;
        }

        .header h1 {
            text-align: center;
            margin: 0;
        }
        .logo-title img {
            height: 90px;
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 15px;
        }
        .header p {
            margin: 0;
        }
        .header a, #logout-button {
             /* Button color */
            color: white; /* Button text color */
            border: none; /* No border */
            border-radius: 4px; /* Rounded corners */
            cursor: pointer; /* Pointer cursor on hover */
            text-decoration: none;
            margin-left: 20px;
        }
        .account-logout {
            text-align: left;
            justify-content: left;
            display: flex;
            flex-direction: column;
        }
        #logout-button {
            background: none;
            text-decoration: none;
            color: white;
        }
        #logout-button:hover {
            color: lightgrey;
        }
        .account-logout a {
            text-align: left;
            justify-content: left;
            padding: 5px;
            font-size: 18px;
        }
        .account-logout a:hover {
            color: lightgrey;
        }
        .header a {
            font-size: 18px;
        }
        .header a:hover {
            color: lightgrey;
            cursor: pointer;
        }
        .header a img {
            width: 75px;
            height: 75px;
        }
        .header a img:hover {
            border: 1px #006466;
            cursor: pointer;
        }
        #logout-button {
            justify-content: left;
            padding: 5px;
            
        }

        .search-section {
            width: 67%;
            height: 5%;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 0;
        }

        .search-bar {
            width: 95%;
            border-radius: 8px;
            padding: 20px;
            background-color: #043D49;
            margin-bottom: 0;
        }

        #search {
            border-radius: 5px;
            padding: 10px;
            width: 82%;
        }

        #restaurant-info {
            display: none;
            height: 82%; /* Full height */
            width: 30%; /* 30% for the sidebar */
            background-color: #f4f4f4;
            margin-left: 10px;
            margin-top: 150px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Scroll if content overflows */
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1; /* Ensure sidebar is above the map */
            padding: 20px; /* Padding inside the info box */
            font-family: 'Inter', sans-serif; /* Font style */
        }

        #restaurant-title {
            font-size: 20px;
            margin-bottom: 0px;
            background: #043D49;
            padding: 1px 20px;
            border-radius: 8px; /* Adds rounded corners */
            align-items: center;
            color: white;
        }

        #sidebar {
            height: 82%; /* Full height */
            width: 30%; /* 30% for the sidebar */
            background-color: #f4f4f4;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Scroll if content overflows */
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1; /* Ensure sidebar is above the map */
            margin: 150px 0 0 0;
        }

        #restaurant-list {
            padding: 20px;
        }

        /* Individual restaurant card styling */
        .restaurant-item {
            color: white;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* Pointer to indicate clickable */
            display: flex;
            background-color: #043D49; /* Card background color */
            border-radius: 8px;
            padding: 15px;
            margin-left: -20px;
            margin-right: -20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Hover effect for cards */
        .restaurant-item:hover {
            transform: translateY(-5px); /* Lift the card slightly on hover */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
        }

        /* Restaurant title style */
        .restaurant-item strong {
            font-size: 18px;
            color: white;
            margin-bottom: 5px;
        }

        /* Additional information styling (e.g., rating, distance) */
        .restaurant-item p {
            margin: 5px 0;
            color: white; /* Sets text color to white */
            font-size: 15px;
        }
        .rating-distance {
            font-size: 12px;
            right: auto;
            margin-left: 15px;
            text-align: right;
        }
        .rating-distance .gold-rating {
            color: gold;
        }

        .search-button {
            background-color: white; /* Background color */
            color: black; /* Text color */
            border: none; /* Remove default border */
            border-radius: 20px; /* Rounded corners */
            padding: 10px 20px; /* Vertical and horizontal padding */
            font-size: 16px; /* Font size */
            cursor: pointer; /* Cursor changes to pointer on hover */
            float: right;
            transition: background-color 0.3s; /* Smooth background color transition */
        }

        .search-button:hover {
            background-color: lightgrey; /* Darker background color on hover */
        }

        .filter-button {
            background-color: white; /* Background color */
            color: black; /* Text color */
            border: none; /* Remove default border */
            border-radius: 5px; /* Rounded corners */
            padding: 10px; /* Padding */
            cursor: pointer; /* Cursor changes to pointer on hover */
            margin-right: 10px; /* Space to the right */
        }

        .filter-dropdown {
            background-color: #043D49; /* Background color for dropdown */
            padding: 10px; /* Padding */
            border: 1px solid #ccc; /* Border */
            border-radius: 5px; /* Rounded corners */
            position: absolute; /* Position the dropdown */
            z-index: 1; /* Ensure it appears on top */
            margin-top: 5px; /* Space from the button */
            display: none; /* Initially hidden */
            width: 50%; /* Width of dropdown */
        }

        .filter-dropdown label {
            margin: 5px 0; /* Space around labels */
            color: white; /* Label color */
        }

        #distance-filter {
            float: left;
            width: 50%;
            margin: 10px 20px;
        }

        #rating-filter {
            float: right;
            width: 50%;
            margin: 10px 20px;
        }

        #favorite-button {
            background-color: #007BFF; /* Button color */
            color: white; /* Button text color */
            border: none; /* No border */
            border-radius: 4px; /* Rounded corners */
            padding: 8px 12px; /* Padding for the button */
            cursor: pointer; /* Pointer cursor on hover */
        }

        #favorite-button:hover {
            background-color: #0056b3; /* Darker button color on hover */
        }

        strong {
            color: #333; /* Color for strong text */
            margin-right: 5px; /* Space between label and content */
        }

        img {
            border-radius: 4px; /* Rounded corners for images */
            margin-bottom: 10px; /* Space below images */
        }

        #get-directions-btn {
            display: none; 
            float: left; 
            margin-right: 15px;
            padding: 10px; 
            border: none; 
            border-radius: 5px; 
            background-color: #004d4f; 
            color: white; 
            cursor: pointer;
        }
        
        #transportation-filter {
            margin-right: 15px;
            padding: 10px; 
            border: none; 
            border-radius: 5px; 
            background-color: white; 
            color: black; 
            cursor: pointer;
            width: 20%;
        }
        

        
    </style>
</head>
<body>
<div class="title-bar">
    <div class="header">
        <div class="logo-title">
            <img src="{% static 'images/Logo.png' %}" alt="logo"> <!-- Replace with your logo URL -->
            <h1>ATLGrub</h1>
            <img src="{% static 'images/Logo.png' %}" alt="logo">
        </div>
        <p>{% if user.is_authenticated %}
            <div class="account-logout">
                <a href="{% url 'googleMaps:account_info' %}">My Account</a>
                <button id = "logout-button" onclick="logout()">Logout</button>
            </div>
                <a href="{% url 'googleMaps:account_info' %}">
                    <img src="{% static 'images/account.png' %}" alt="account">
                </a>

                <script>
                    function logout() {
                        fetch('/googleMaps/logout/', {  // Ensure this points to the correct path
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}' // Add this line
                            }
                        })
                            .then(response => {
                                if (response.ok) {
                                    window.location.href = '/googleMaps'; // Redirect to the desired page
                                } else {
                                    alert('Logout failed. Please try again.');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Logout failed. Please try again.');
                            });
                    }
                </script>

            {% else %}
                <a href="{% url 'auth:user_login' %}">Login</a>
            {% endif %}
    </div>
</div>
<div class="search-section">
    <div class="search-bar">
        <!-- Sandwich button for filters -->
        <button class="filter-button" onclick="toggleFilters()">&#9776;</button>

        <!-- Filter dropdown (initially hidden) -->
        <div id="filter-dropdown" class="filter-dropdown">
            <div id="distance-filter">
                <label>Maximum Distance</label><br><br>
                <input type="radio" id="1-mile" name="max-distance" value="1609.34">
                <label for="1-mile">1 mile</label><br>
                <input type="radio" id="5-miles" name="max-distance" value="8046.72">
                <label for="5-miles">5 miles</label><br>
                <input type="radio" id="10-miles" name="max-distance" value="16093.4">
                <label for="10-miles">10 miles</label><br>
                <input type="radio" id="15-miles" name="max-distance" value="24140.2">
                <label for="15-miles">15 miles</label><br>
            </div>

            <div id="rating-filter">
                <label>Minimum Rating</label><br><br>
                <input type="radio" id="rating-1" name="min-rating" value="1">
                <label for="rating-1">⭐</label><br>
                <input type="radio" id="rating-2" name="min-rating" value="2">
                <label for="rating-2">⭐⭐</label><br>
                <input type="radio" id="rating-3" name="min-rating" value="3">
                <label for="rating-3">⭐⭐⭐</label><br>
                <input type="radio" id="rating-4" name="min-rating" value="4">
                <label for="rating-4">⭐⭐⭐⭐</label><br>
            </div>
        </div>
        <input id="search" type="text" placeholder="Search for restaurants...">
        <button class="search-button" onclick="searchRestaurants()">Search</button>
    </div>
</div>

<div id="restaurant-info">
    <h2></h2>
    <div id="info">Click on a marker to see details!</div>
    <div style="width: 100%;">
        <button id="get-directions-btn" onclick="getDirections()">Get Directions</button>
        <select id="transportation-filter">
            <option value="DRIVING">Driving</option>
            <option value="WALKING">Walking</option>
            <option value="BICYCLING">Bicycling</option>
        </select>
    </div>
    <br><br>
</div>
<br><br>

<div id="sidebar">
    <div id="restaurant-title">
        <h2>Restaurants</h2>
    </div>
    <div id="restaurant-list"></div>
</div>

<div id="map"></div>


<script>
    let map;
    let service;
    let markers = [];
    let userLocation = null;
    let selectedPlace = null;
    let directionsRenderer = null;
    let mode = document.getElementById("transportation-filter").value;
    let maxDistance = 24142;
    let mapZoom = 14;

    // Initialize and add the map
    function initMap() {
        var atlanta = {lat: 33.7490, lng: -84.3880};
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: mapZoom,
            center: atlanta
        });

        searchRestaurants()
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "#00F",
                    fillOpacity: 0.8,
                    strokeColor: '#00F',
                    strokeWeight: 2
                }
            });
            map.setCenter(userLocation);
        }, function () {
            console.error("Geolocation failed.");
        });
    } else {
        console.error("Browser doesn't support Geolocation.");
    }
    
    function toggleFilters() {
        const dropdown = document.getElementById('filter-dropdown');
        // Toggle the display of the dropdown
        dropdown.style.display = dropdown.style.display === 'none' || dropdown.style.display === '' ? 'flex' : 'none';
    }

    // Prevent dropdown from closing when clicking inside
    document.getElementById('filter-dropdown').addEventListener('click', function(event) {
        event.stopPropagation(); // Prevent click event from bubbling up to the document listener
    });

    // Function to search for restaurants based on user input and filter
    async function searchRestaurants() {
        clearMarkers();
        clearSidebar();
        clearDirections();
        back();

        const searchTerm = document.getElementById('search').value || "restaurant";
        const maxDistance = parseFloat(document.querySelector('input[name="max-distance"]:checked')?.value || Infinity);
        if (maxDistance < 1700) {
            mapZoom = 14;
        } else if (maxDistance < 9000) {
            mapZoom = 13;
        } else if (maxDistance < 16500) {
            mapZoom = 11;
        } else if (maxDistance < 24500) {
            mapZoom = 11;
        } else {
            mapZoom = 14;
        }
        
        console.log(mapZoom)
        map.setZoom(mapZoom);
        const minRating = parseFloat(document.querySelector('input[name="min-rating"]:checked')?.value || 1);
        let request = null;

        const {Place} = await google.maps.importLibrary("places");

        // Get URL parameters to see if an address of a favorite is there
        const urlParams = new URLSearchParams(window.location.search);
        const addressFromUrl = urlParams.get('address');
        const formattedAddress = addressFromUrl ? decodeURIComponent(addressFromUrl) : null;

        // Search for favorite
        if (formattedAddress) {
            request = {
                textQuery: formattedAddress,
                fields: ["displayName", "location", "formattedAddress", "nationalPhoneNumber",
                    "rating", "photos", "types", "reviews"],
                includedType: "restaurant",
                locationBias: userLocation,
                maxResultCount: 20,
                minRating: minRating,
                region: "us",
                useStrictTypeFiltering: true,
            };
            const {places} = await Place.searchByText(request);
            if (!places.length) {
                console.error("No restaurants found.");
            } else {
                places.forEach(place => {
                    createMarker(place);
                    // Center the map on the place's location
                    map.setCenter(place.location);
                    map.setZoom(18);
                    // Deletes address from URL
                    urlParams.delete('address');
                    window.history.replaceState({}, document.title, window.location.pathname + '' + urlParams.toString());
                });
            }
        } 
        
        // Search for what is in the search bar or "restaurant" if search bar empty
        else { 
            request = {
                textQuery: searchTerm,
                fields: ["displayName", "location", "formattedAddress", "nationalPhoneNumber",
                    "rating", "photos", "types", "reviews"],
                includedType: "restaurant",
                locationBias: userLocation,
                maxResultCount: 20,
                minRating: minRating,
                region: "us",
                useStrictTypeFiltering: true,
            };

            const {places} = await Place.searchByText(request);
            if (!places.length) {
                console.error("No restaurants found.");
            } else {
                places.forEach(place => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        place.location,
                        userLocation || map.getCenter()  // Use user's location or the center of the map
                    );
                    if (distance <= maxDistance) {
                        createMarker(place);
                    }
                });
            }
        }
    }

    function capitalizeFirstLetter(string) {
        if (typeof string !== 'string') return string; // Ensure it's a string
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Function to create markers and add them to the map
    function createMarker(place) {
        const marker = new google.maps.Marker({
            map: map,
            position: place.location
        });

        markers.push(marker);
        addToSidebar(place);

        google.maps.event.addListener(marker, 'click', function () {
            clearDirections();
            back();
            map.setCenter(place.location);
            map.setZoom(18);

            selectedPlace = place.location;
            const photos = place.photos;

            const allowedCuisines = [
                'american_restaurant', 'bakery', 'bar', 'barbecue_restaurant',
                'brazilian_restaurant', 'breakfast_restaurant', 'brunch_restaurant',
                'cafe', 'chinese_restaurant', 'coffee_shop', 'fast_food_restaurant',
                'french_restaurant', 'greek_restaurant', 'hamburger_restaurant',
                'ice_cream_shop', 'indian_restaurant', 'indonesian_restaurant',
                'italian_restaurant', 'japanese_restaurant', 'korean_restaurant',
                'lebanese_restaurant', 'meal_delivery', 'meal_takeaway',
                'mediterranean_restaurant', 'mexican_restaurant', 'middle_eastern_restaurant',
                'pizza_restaurant', 'ramen_restaurant', 'sandwich_shop',
                'seafood_restaurant', 'spanish_restaurant', 'steak_house',
                'sushi_restaurant', 'thai_restaurant', 'turkish_restaurant',
                'vegan_restaurant', 'vegetarian_restaurant'
            ];

            const cuisineNames = {
                'american_restaurant': 'American', 'bakery': 'Bakery', 'bar': 'Bar',
                'barbecue_restaurant': 'Barbecue', 'brazilian_restaurant': 'Brazilian',
                'breakfast_restaurant': 'Breakfast', 'brunch_restaurant': 'Brunch',
                'cafe': 'Café', 'chinese_restaurant': 'Chinese', 'coffee_shop': 'Coffee Shop',
                'fast_food_restaurant': 'Fast Food', 'french_restaurant': 'French',
                'greek_restaurant': 'Greek', 'hamburger_restaurant': 'Hamburger',
                'ice_cream_shop': 'Ice Cream', 'indian_restaurant': 'Indian',
                'indonesian_restaurant': 'Indonesian', 'italian_restaurant': 'Italian',
                'japanese_restaurant': 'Japanese', 'korean_restaurant': 'Korean',
                'lebanese_restaurant': 'Lebanese', 'meal_delivery': 'Meal Delivery',
                'meal_takeaway': 'Meal Takeaway', 'mediterranean_restaurant': 'Mediterranean',
                'mexican_restaurant': 'Mexican', 'middle_eastern_restaurant': 'Middle Eastern',
                'pizza_restaurant': 'Pizza', 'ramen_restaurant': 'Ramen',
                'sandwich_shop': 'Sandwich', 'seafood_restaurant': 'Seafood',
                'spanish_restaurant': 'Spanish', 'steak_house': 'Steak House',
                'sushi_restaurant': 'Sushi', 'thai_restaurant': 'Thai',
                'turkish_restaurant': 'Turkish', 'vegan_restaurant': 'Vegan',
                'vegetarian_restaurant': 'Vegetarian'
            };

            const selectedCuisines = place.types
                .filter(type => allowedCuisines.includes(type))
                .map(type => cuisineNames[type]);
            const cuisinesDisplay = selectedCuisines.length > 0
                ? selectedCuisines.join(', ')
                : 'Restaurant';

            checkIfFavorited(place.id);

            document.getElementById('info').innerHTML = `
                <div id="restaurant-details" class="restaurant-details">
                    <div style="display: flex; margin-bottom: 10px; width: 100%;">
                        <div style="display: flex; width: 50%;">
                            <button onclick="searchRestaurants()" id="back-button"
                                style="padding: 10px; border: none; border-radius: 5px; background-color: #6c757d; color: white; cursor: pointer;">
                            Back
                        </button>
                        </div>
                        <div style="display: flex; width: 50%; float: right; justify-content: right;">
                            <button id="favorite-button" onclick="favoriteRestaurant('${place.id}')"
                                    style="margin-right: 10px; padding: 10px; border: none; border-radius: 5px; background-color: #004d4f; color: white; cursor: pointer;">
                                ${favoriteState ? 'Unfavorite' : 'Favorite'}
                            </button>
                        </div>
                    </div>
                    <div style="overflow: auto; white-space: nowrap;">
                        ${photos.length > 0 ? photos.slice(0, 3).map(photo => {
                            const photoUrl = photo.getURI({maxWidth: 400, maxHeight: 400});
                            return `<img src="${photoUrl}" alt="Photo of ${place.name}"
                                        style="width: 150px;
                                               height: 150px;
                                               padding: 5px;
                                               margin-bottom: 10px;
                                               display: inline-block;
                                               object-fit: cover;"
                                        onerror="this.style.display='none';">`;
                        }).join('') : 'No photos available.'}<br>
                    </div>
                    <div style="display: flex; text-align: center;">
                        <strong id="restaurant-name" style="font-size: 30px;">${place.displayName}</strong><br>
                    </div>
                    <br>
                    <strong style="font-size: 16px;">Address:</strong> <span style="font-size: 14px;">${place.formattedAddress || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Phone:</strong> <span style="font-size: 14px;">${place.nationalPhoneNumber || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Rating:</strong> <span style="font-size: 14px;">${place.rating || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Cuisines:</strong> <span style="font-size: 14px;">${cuisinesDisplay|| 'N/A'}</span><br>
                    <br>
                    <strong style="font-size: 16px;">Reviews</strong><br>
                    <br>
                    <div style="overflow-x: auto; display: flex;">
                        ${place.reviews ? place.reviews.map(review => `
                            <div class="review" style="font-size: 15px; 
                                                       color: white; 
                                                       margin: 0 15px 15px 0; 
                                                       padding: 10px; 
                                                       border: 1px solid #ccc; 
                                                       background-color: #004d4f; 
                                                       border-radius: 8px; 
                                                       max-height: 250px;
                                                       min-width: 350px;
                                                       word-wrap: break-word; /* Ensures words wrap */
                                                       overflow-wrap: break-word;
                                                       overflow-y: auto;">
                                <strong style="font-size: 20px; color: white;">${review.authorAttribution.displayName}</strong><br><br>
                                Rating: ${review.rating} ⭐<br>
                                ${review.text}<br><br>
                            </div>
                        `).join('') : 'No reviews available.'}
                    </div>
                </div>`;

            // Show the sidebar
            document.getElementById('restaurant-info').style.display = 'block';
            document.getElementById('restaurant-info').style.width = '30%';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('map').style.width = '68%';
            document.getElementById('get-directions-btn').style.display = 'block';
        });
        
    }

    function getDirections() {
        // Update the mode variable to get the latest value from the dropdown
        document.getElementById("transportation-filter").addEventListener("change", function () {
            mode = this.value;
            console.log("Transportation mode changed to:", mode);
        });

        if (!userLocation || !selectedPlace) {
            alert("User location or destination not found!");
            return;
        }

        clearDirections();

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        let request = {
            origin: userLocation,
            destination: selectedPlace,
            travelMode: google.maps.TravelMode[mode] // Use the mode directly
        };

        directionsService.route(request, function (result, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            } else {
                alert("Directions request failed: " + status);
            }
        });
    }

    // Function to add restaurant details to the sidebar
    function addToSidebar(place) {
        const restaurantList = document.getElementById('restaurant-list');
        const restaurantItem = document.createElement('div');
        restaurantItem.className = 'restaurant-item';
        restaurantItem.innerHTML = `
            <strong>${place.displayName}</strong>
            <div class="rating-distance">
                <b class="gold-rating">Rating: </b><span>${place.rating || 'N/A'} ⭐</span><br>
                <b>Distance:</b> ${(Math.round(google.maps.geometry.spherical.computeDistanceBetween(
                place.location,
                userLocation || map.getCenter()
            )) / 1609.34).toFixed(2)} miles
            </div>`;

        // When clicking on the sidebar item, it simulates clicking the map marker
        restaurantItem.addEventListener('click', function () {
            clearDirections();
            back();
            map.setCenter(place.location);
            map.setZoom(18);

            selectedPlace = place.location;
            const photos = place.photos;

            const allowedCuisines = [
                'american_restaurant', 'bakery', 'bar', 'barbecue_restaurant',
                'brazilian_restaurant', 'breakfast_restaurant', 'brunch_restaurant',
                'cafe', 'chinese_restaurant', 'coffee_shop', 'fast_food_restaurant',
                'french_restaurant', 'greek_restaurant', 'hamburger_restaurant',
                'ice_cream_shop', 'indian_restaurant', 'indonesian_restaurant',
                'italian_restaurant', 'japanese_restaurant', 'korean_restaurant',
                'lebanese_restaurant', 'meal_delivery', 'meal_takeaway',
                'mediterranean_restaurant', 'mexican_restaurant', 'middle_eastern_restaurant',
                'pizza_restaurant', 'ramen_restaurant', 'sandwich_shop',
                'seafood_restaurant', 'spanish_restaurant', 'steak_house',
                'sushi_restaurant', 'thai_restaurant', 'turkish_restaurant',
                'vegan_restaurant', 'vegetarian_restaurant'
            ];

            const cuisineNames = {
                'american_restaurant': 'American', 'bakery': 'Bakery', 'bar': 'Bar',
                'barbecue_restaurant': 'Barbecue', 'brazilian_restaurant': 'Brazilian',
                'breakfast_restaurant': 'Breakfast', 'brunch_restaurant': 'Brunch',
                'cafe': 'Café', 'chinese_restaurant': 'Chinese', 'coffee_shop': 'Coffee Shop',
                'fast_food_restaurant': 'Fast Food', 'french_restaurant': 'French',
                'greek_restaurant': 'Greek', 'hamburger_restaurant': 'Hamburger',
                'ice_cream_shop': 'Ice Cream', 'indian_restaurant': 'Indian',
                'indonesian_restaurant': 'Indonesian', 'italian_restaurant': 'Italian',
                'japanese_restaurant': 'Japanese', 'korean_restaurant': 'Korean',
                'lebanese_restaurant': 'Lebanese', 'meal_delivery': 'Meal Delivery',
                'meal_takeaway': 'Meal Takeaway', 'mediterranean_restaurant': 'Mediterranean',
                'mexican_restaurant': 'Mexican', 'middle_eastern_restaurant': 'Middle Eastern',
                'pizza_restaurant': 'Pizza', 'ramen_restaurant': 'Ramen',
                'sandwich_shop': 'Sandwich', 'seafood_restaurant': 'Seafood',
                'spanish_restaurant': 'Spanish', 'steak_house': 'Steak House',
                'sushi_restaurant': 'Sushi', 'thai_restaurant': 'Thai',
                'turkish_restaurant': 'Turkish', 'vegan_restaurant': 'Vegan',
                'vegetarian_restaurant': 'Vegetarian'
            };

            const selectedCuisines = place.types
                .filter(type => allowedCuisines.includes(type))
                .map(type => cuisineNames[type]);

            const cuisinesDisplay = selectedCuisines.length > 0
                ? selectedCuisines.join(', ')
                : 'Restaurant';

            checkIfFavorited(place.id);

            document.getElementById('info').innerHTML = `
                <div id="restaurant-details" class="restaurant-details">
                    <div style="display: flex; margin-bottom: 10px; width: 100%;">
                        <div style="display: flex; width: 50%;">
                            <button onclick="searchRestaurants()" id="back-button"
                                style="padding: 10px; border: none; border-radius: 5px; background-color: #6c757d; color: white; cursor: pointer;">
                            Back
                        </button>
                        </div>
                        <div style="display: flex; width: 50%; float: right; justify-content: right;">
                            <button id="favorite-button" onclick="favoriteRestaurant('${place.id}')"
                                    style="margin-right: 10px; padding: 10px; border: none; border-radius: 5px; background-color: #004d4f; color: white; cursor: pointer;">
                                ${favoriteState ? 'Unfavorite' : 'Favorite'}
                            </button>
                        </div>
                    </div>
                    <div style="overflow: auto; white-space: nowrap;">
                        ${photos.length > 0 ? photos.slice(0, 3).map(photo => {
                            const photoUrl = photo.getURI({maxWidth: 300, maxHeight: 400});
                            return `<img src="${photoUrl}" alt="Photo of ${place.name}"
                                        style="width: 150px;
                                               height: 150px;
                                               padding: 5px;
                                               margin-bottom: 10px;
                                               display: inline-block;
                                               object-fit: cover;"
                                        onerror="this.style.display='none';">`;
                        }).join('') : 'No photos available.'}<br>
                    </div>
                    <div style="display: flex; text-align: center;">
                        <strong id="restaurant-name" style="font-size: 30px;">${place.displayName}</strong><br>
                    </div>
                    <br>
                    <strong style="font-size: 16px;">Address:</strong> <span style="font-size: 14px;">${place.formattedAddress || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Phone:</strong> <span style="font-size: 14px;">${place.nationalPhoneNumber || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Rating:</strong> <span style="font-size: 14px;">${place.rating || 'N/A'}</span><br>
                    <strong style="font-size: 16px;">Cuisines:</strong> <span style="font-size: 14px;">${cuisinesDisplay|| 'N/A'}</span><br>
                    <br><br>
                    <strong style="font-size: 16px;">Reviews</strong><br>
                    <br>
                    <div style="overflow-x: auto; display: flex;">
                        ${place.reviews ? place.reviews.map(review => `
                            <div class="review" style="font-size: 15px; 
                                                       color: white; 
                                                       margin: 0 15px 15px 0; 
                                                       padding: 10px; 
                                                       border: 1px solid #ccc; 
                                                       background-color: #004d4f; 
                                                       border-radius: 8px; 
                                                       max-width: 300px;
                                                       min-width: 200px;
                                                       max-height: 250px;
                                                       word-wrap: break-word; /* Ensures words wrap */
                                                       overflow-wrap: break-word;
                                                       overflow-y: auto;">
                                <strong style="font-size: 18px; color: white;">${review.authorAttribution.displayName}</strong><br><br>
                                <b>Rating:</b> ${review.rating} ⭐<br>
                                ${review.text}<br><br>
                            </div>
                        `).join('') : 'No reviews available.'}
                    </div>
                </div>`;

            // Show the sidebar
            document.getElementById('restaurant-info').style.display = 'block';
            document.getElementById('restaurant-info').style.width = '30%';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('map').style.width = '68%';
            document.getElementById('get-directions-btn').style.display = 'block';
        });

        restaurantList.appendChild(restaurantItem);
        document.getElementById('sidebar').style.display = 'block';
    }

    // Function to clear markers from the map
    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }

    // Function to clear sidebar content
    function clearSidebar() {
        document.getElementById('restaurant-list').innerHTML = '';
    }

    function clearInfo() {
        document.getElementById('info').innerHTML = '';
    }

    function clearDirections() {
        if (directionsRenderer) {
            directionsRenderer.setMap(null);
            directionsRenderer = null;
        }
    }

    function back() {
        document.getElementById("sidebar").style.width = '30%';
        document.getElementById('restaurant-info').style.display = 'none';
        document.getElementById("info").innerHTML = '';
        // Set the center of the map to the user's location and reset the zoom
        if (userLocation) {
            // Check if the current zoom is not correct or the center is not the user's location
            if (map.getZoom() != mapZoom || !map.getCenter().equals(userLocation)) {
                map.setCenter(userLocation); // Set the center to user's location
                map.setZoom(mapZoom);
            }
        }
    }

    const csrfToken = getCookie('csrftoken');
    let favoriteState = false; // Initialize favorite state

    function favoriteRestaurant(placeId) {
        getCurrentUserId().then(userId => {
            if (!userId) {
                alert('You must be logged in to favorite a restaurant.');
                return;
            }

            const method = favoriteState ? 'DELETE' : 'POST'; // Change method based on state
            const endpoint = favoriteState ? `api/unfavorite/${placeId}/` : 'api/favorite/';

            fetch(endpoint, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken, // Make sure csrfToken is defined
                },
                body: JSON.stringify({placeId})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        favoriteState = !favoriteState; // Toggle favorite state
                        updateFavoriteButton();
                        alert(favoriteState ? 'Restaurant added to favorites!' : 'Restaurant removed from favorites!');
                    } else {
                        alert('Error updating favorite status: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    }

    function updateFavoriteButton() {
        const button = document.getElementById('favorite-button'); // Adjust to your button's ID
        button.textContent = favoriteState ? 'Unfavorite' : 'Favorite';
    }

    function checkIfFavorited(placeId) {
        fetch(`api/is_favorited/${placeId}/`) // Create an endpoint to check if a restaurant is favorited
            .then(response => response.json())
            .then(data => {
                favoriteState = data.isFavorited; // Set the favorite state based on server response
                updateFavoriteButton(); // Update the button text
            })
            .catch(error => console.error('Error checking favorite state:', error));
    }

</script>
</body>
</html>
