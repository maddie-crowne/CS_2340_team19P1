<!DOCTYPE html>
<html>
<head>
    <title>Restaurants in Atlanta</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initMap" async defer></script>
    <style>
        /* Set the size of the map */
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%; /* Full height */
            width: 100%;  /* Full width */
            transition: all 0.3s; /* Smooth transition for sidebar */
        }
        #sidebar {
            display: none; /* Hidden by default */
            height: 100%; /* Full height */
            width: 30%;   /* 30% for the sidebar */
            background-color: #f4f4f4;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Scroll if content overflows */
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1; /* Ensure sidebar is above the map */
        }
    </style>
</head>
<body>

    <div style="padding: 10px;">
        <input id="search-bar" type="text" placeholder="Search for restaurants...">
                <input type="number" id="max-distance" name="max-distance" min="500" step="500" value="5000">
        <input type="number" id="min-rating" name="min-rating" min="1" max="5" step="0.1" value="4.0">
        <select id="filter-dropdown">
            <option value="">All Cuisines</option>
            <option value="American">American</option>
            <option value="Asian">Asian</option>
            <option value="BBQ">BBQ</option>
            <option value="Cajun/Creole">Cajun/Creole</option>
            <option value="Caribbean">Caribbean</option>
            <option value="Chinese">Chinese</option>
            <option value="Fast Food">Fast Food</option>
            <option value="French">French</option>
            <option value="Greek">Greek</option>
            <option value="Indian">Indian</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Latin American">Latin American</option>
            <option value="Mediterranean">Mediterranean</option>
            <option value="Mexican">Mexican</option>
            <option value="Middle Eastern">Middle Eastern</option>
            <option value="Seafood">Seafood</option>
            <option value="Southern">Southern</option>
            <option value="Spanish">Spanish</option>
            <option value="Thai">Thai</option>
            <option value="Vegan">Vegan</option>
            <option value="Vegetarian">Vegetarian</option>
            <option value="Vietnamese">Vietnamese</option>
        </select>
        <button onclick="searchRestaurants()">Search</button>
        <a href="{% url 'auth:account_info' %}">My Account</a>
    </div>
    
<div id="map"></div>
<div id="sidebar">
    <h2>Restaurant Info</h2>
    <div id="info">Click on a marker to see details!</div>
    <button id="get-directions-btn" style="display: none;" onclick="getDirections()">Get Directions</button>
    <select id="transportation-filter">
        <option value="DRIVING">Driving</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Bicycling</option>
    </select>
</div>

<script>
    // Initialize and add the map
    let map;
    let service;
    let markers = [];
    let userLocation = null;
    let selectedPlace = null;
    let directionsRenderer = null;
    let mode = document.getElementById("transportation-filter").value;

    // Initialize and add the map
    function initMap() {
        var atlanta = { lat: 33.7490, lng: -84.3880 };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: atlanta
        });

        // Create a PlacesService object
        service = new google.maps.places.PlacesService(map);

        // Initial search for all restaurants
        searchRestaurants();
    }
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "#00F",
                    fillOpacity: 0.8,
                    strokeColor: '#00F',
                    strokeWeight: 2
                }
            });
            map.setCenter(userLocation);
        }, function() {
            console.error("Geolocation failed.");
        });
    } else {
        console.error("Browser doesn't support Geolocation.");
    }

    // Function to search for restaurants based on user input and filter
    function searchRestaurants() {
        // Clear existing markers
        clearDirections();
        clearMarkers();
        

        // Get user input and selected filter
        const searchTerm = document.getElementById('search-bar').value || 'restaurants in Atlanta';
        const maxDistance = parseFloat(document.getElementById('max-distance').value);
        const minRating = parseFloat(document.getElementById('min-rating').value);
        const filter = document.getElementById('filter-dropdown').value;

        // Define the request for restaurants in Atlanta with filter
        const request = {
            query: [searchTerm, filter],
            fields: ['name', 'geometry', 'place_id', 'types'],
            type: filter
        };

        // Perform the text search
        service.textSearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                results.forEach(place => {
                    if (place.rating >= minRating) {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            place.geometry.location,
                            map.getCenter()
                        )
                        
                        if (distance <= maxDistance) {
                            createMarker(place);
                        }
                    }
                });
            }
        });
    }

    // Function to create markers and add them to the map
    function createMarker(place) {
        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
        });

        markers.push(marker);

        // Add click event to marker
        google.maps.event.addListener(marker, 'click', function() {
            clearDirections();
            service.getDetails({ placeId: place.place_id }, function(placeDetails, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    selectedPlace = placeDetails.geometry.location;
                    const cuisine = document.getElementById('filter-dropdown').value;

                    const photos = placeDetails.photos;
                    // Set the content of the sidebar with detailed info
                    document.getElementById('info').innerHTML = `
                        <strong>${placeDetails.name}</strong><br>
                        <strong>Address:</strong> ${placeDetails.formatted_address || 'N/A'}<br>
                        <strong>Phone:</strong> ${placeDetails.formatted_phone_number || 'N/A'}<br>
                        <strong>Cuisine:</strong> ${cuisine || 'N/A'}<br>
                        <strong>Rating:</strong> ${placeDetails.rating || 'N/A'}<br>

                        <strong>Photos:</strong><br>
                            ${photos.length > 0 ? photos.map(photo => {
                                // Assuming you have a valid PlacesService instance
                                const photoUrl = photo.getUrl({ maxWidth: 400, maxHeight: 400 });
                                return `
                                    <img src="${photoUrl}" alt="Photo of ${placeDetails.name}" style="width: 100%; max-width: 150px; height: auto; margin-bottom: 10px;" onerror="this.style.display='none';">
                                `;
                             }).join('') : 'No photos available.'}<br>

                        <strong>Reviews:</strong><br>
                        ${placeDetails.reviews ? placeDetails.reviews.map(review => `
                            <div>
                                <strong>${review.author_name}</strong><br>
                                Rating: ${review.rating}<br>
                                ${review.text}<br><br>
                            </div>
                        `).join('') : 'No reviews available.'}
                    `;

                    // Show the sidebar
                    document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('map').style.width = '70%'; 
                    document.getElementById('get-directions-btn').style.display = 'block';
                }
            });
        });
    }
    
    function getDirections() {
        // Update the mode variable to get the latest value from the dropdown
        document.getElementById("transportation-filter").addEventListener("change", function() {
            mode = this.value;
            console.log("Transportation mode changed to:", mode);
        });
    
        if (!userLocation || !selectedPlace) {
            alert("User location or destination not found!");
            return;
        }
        
        clearDirections();
        
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
        
        let request = {
            origin: userLocation,
            destination: selectedPlace,
            travelMode: google.maps.TravelMode[mode] // Use the mode directly
        };
        
        directionsService.route(request, function(result, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            } else {
                alert("Directions request failed: " + status);
            }
        });
    }
    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }
    function clearDirections() {
        if (directionsRenderer) {
            directionsRenderer.setMap(null);
            directionsRenderer = null;
        }
    }

</script>

</body>
</html>
