<!DOCTYPE html>
<html>
<head>
    <title>Restaurants in Atlanta</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initMap" async defer></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
            width: 70%;
            transition: all 0.3s;
            float: left;
        }
        #restaurant-info {
            display: none;
            height: 100%; /* Full height */
            width: 30%;   /* 30% for the sidebar */
            background-color: #f4f4f4;
            padding: 10px;
            margin-left: 10px;
            margin-right: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Scroll if content overflows */
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1; /* Ensure sidebar is above the map */

        }
        #sidebar {
            height: 100%; /* Full height */
            width: 30%;   /* 30% for the sidebar */
            background-color: #f4f4f4;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Scroll if content overflows */
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1; /* Ensure sidebar is above the map */
        }
        .restaurant-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .restaurant-item:hover {
            background-color: #ddd;
        }

    </style>
</head>
<body>

<div style="padding: 10px;">
    <input id="search-bar" type="text" placeholder="Search for restaurants...">
    <select id="max-distance" name="max-distance">
            <option value="1609.34">1 mile</option>
            <option value="8046.72">5 miles</option>
            <option value="16093.4">10 miles</option>
            <option value="24140.2">15 miles</option>
    </select>
    <input type="number" id="min-rating" name="min-rating" min="1" max="5" step="0.1" value="4.0">
    <button onclick="searchRestaurants()">Search</button>
    {% if user.is_authenticated %}
            <a href="{% url 'googleMaps:account_info' %}">My Account</a>
            
            <button onclick="logout()">Logout</button>
            
            <script>
                function logout() {
                    console.log("YES")
                    fetch('/googleMaps/logout/', {  // Ensure this points to the correct path
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}' // Add this line
                        }
                    })
                    .then(response => {
                        console.log("YES 2")
                        if (response.ok) {
                            window.location.href = '/googleMaps'; // Redirect to the desired page
                        } else {
                            alert('Logout failed. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Logout failed. Please try again.');
                    });
                }
        </script>

        {% else %}
            <a href="{% url 'auth:login' %}">Login</a>
        {% endif %}
</div>

<div id="map"></div>
<div id="restaurant-info">
    <h2>Restaurant Info</h2>
    <button onclick="searchRestaurants()">Back</button>
    <div id="info">Click on a marker to see details!</div>
    <button id="get-directions-btn" style="display: none;" onclick="getDirections()">Get Directions</button>
    <select id="transportation-filter">
        <option value="DRIVING">Driving</option>
        <option value="WALKING">Walking</option>
        <option value="BICYCLING">Bicycling</option>
    </select>
</div>
<div id="sidebar">
    <h2>Restaurants</h2>
    <div id="restaurant-list"></div>
</div>

<script>
    let map;
    let service;
    let markers = [];
    let userLocation = null;
    let selectedPlace = null;
    let directionsRenderer = null;
    let mode = document.getElementById("transportation-filter").value;

    // Initialize and add the map
    function initMap() {
        var atlanta = { lat: 33.7490, lng: -84.3880 };
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 12,
            center: atlanta
        });

        service = new google.maps.places.PlacesService(map);

        // Initial search for restaurants
        searchRestaurants();
        
        {#clearSidebar()#}
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Your Location",
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: "#00F",
                    fillOpacity: 0.8,
                    strokeColor: '#00F',
                    strokeWeight: 2
                }
            });
            map.setCenter(userLocation);
        }, function() {
            console.error("Geolocation failed.");
        });
    } else {
        console.error("Browser doesn't support Geolocation.");
    }

    // Function to search for restaurants based on user input and filter
    function searchRestaurants() {
        clearMarkers();
        clearSidebar();
        clearDirections();
        back();

        const searchTerm = document.getElementById('search-bar').value || 'restaurants in Atlanta';
        const maxDistance = parseFloat(document.getElementById('max-distance').value);
        const minRating = parseFloat(document.getElementById('min-rating').value);

        const request = {
            query: searchTerm,
            fields: ['name', 'geometry', 'place_id', 'rating']
        };

        service.textSearch(request, function(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                if (results.length === 0) {
                    console.error("No restaurants found.");
                    return;
                }
                results.forEach(place => {
                    if (place.rating >= minRating) {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(
                            place.geometry.location,
                            userLocation || map.getCenter()  // Use user's location or the center of the map
                        );

                        if (distance <= maxDistance) {
                            createMarker(place);
                            // Add restaurant to sidebar
                        }
                    }
                });
            } else {
                console.error("Search failed: " + status);
            }
        });
    }

    // Function to create markers and add them to the map
    function createMarker(place) {
        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
        });

        markers.push(marker);
        addToSidebar(place);

        // Add click event to marker to navigate to another page with restaurant info
        google.maps.event.addListener(marker, 'click', function() {
            clearDirections();
            back();
            service.getDetails({ placeId: place.place_id }, function(placeDetails, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    selectedPlace = placeDetails.geometry.location;
                    const photos = placeDetails.photos;
                    // Set the content of the sidebar with detailed info
                    console.log(placeDetails.name);
                    document.getElementById('info').innerHTML = `
                        <strong>${placeDetails.name}</strong><br>
                        <strong>Address:</strong> ${placeDetails.formatted_address || 'N/A'}<br>
                        <strong>Phone:</strong> ${placeDetails.formatted_phone_number || 'N/A'}<br>
                        <strong>Rating:</strong> ${placeDetails.rating || 'N/A'}<br>
                        <strong>Photos:</strong><br>
                            ${photos.length > 0 ? photos.map(photo => {
                                // Assuming you have a valid PlacesService instance
                                const photoUrl = photo.getUrl({ maxWidth: 400, maxHeight: 400 });
                                return `
                                    <img src="${photoUrl}" alt="Photo of ${placeDetails.name}" style="width: 100%; max-width: 150px; height: auto; margin-bottom: 10px;" onerror="this.style.display='none';">
                                `;
                             }).join('') : 'No photos available.'}<br>

                        <strong>Reviews:</strong><br>
                        ${placeDetails.reviews ? placeDetails.reviews.map(review => `
                            <div>
                                <strong>${review.author_name}</strong><br>
                                Rating: ${review.rating}<br>
                                ${review.text}<br><br>
                            </div>
                        `).join('') : 'No reviews available.'}
                    `;

                    // Show the sidebar
                    //document.getElementById('sidebar').style.display = 'block';
                    document.getElementById('restaurant-info').style.display = 'block';
                    document.getElementById('restaurant-info').style.width = '30%';
                    document.getElementById('sidebar').style.display = 'none';
                    document.getElementById('map').style.width = '70%';
                    document.getElementById('get-directions-btn').style.display = 'block';
                } else {
                    console.log("didn't work")
                }
            });
        });
    }
    function getDirections() {
        // Update the mode variable to get the latest value from the dropdown
        document.getElementById("transportation-filter").addEventListener("change", function() {
            mode = this.value;
            console.log("Transportation mode changed to:", mode);
        });

        if (!userLocation || !selectedPlace) {
            alert("User location or destination not found!");
            return;
        }

        clearDirections();

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);

        let request = {
            origin: userLocation,
            destination: selectedPlace,
            travelMode: google.maps.TravelMode[mode] // Use the mode directly
        };

        directionsService.route(request, function(result, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(result);
            } else {
                alert("Directions request failed: " + status);
            }
        });
    }

    // Function to add restaurant details to the sidebar
    function addToSidebar(place) {
        const restaurantList = document.getElementById('restaurant-list');
        const restaurantItem = document.createElement('div');
        restaurantItem.className = 'restaurant-item';
        restaurantItem.innerHTML = `
            <strong>${place.name}</strong><br>
            Rating: ${place.rating || 'N/A'}<br>
            Distance: ${(Math.round(google.maps.geometry.spherical.computeDistanceBetween(
                place.geometry.location,
                userLocation || map.getCenter()
            )) / 1609.34).toFixed(2)} miles
        `;

        // When clicking on the sidebar item, it simulates clicking the map marker
       restaurantItem.addEventListener('click', function() {
            clearDirections();
            back();
            service.getDetails({ placeId: place.place_id }, function(placeDetails, status) {
                selectedPlace = placeDetails.geometry.location;
                const photos = placeDetails.photos;
                // Set the content of the sidebar with detailed info
                console.log(placeDetails.name);
                document.getElementById('info').innerHTML = `
                       <strong>${placeDetails.name}</strong><br>
                       <strong>Address:</strong> ${placeDetails.formatted_address || 'N/A'}<br>
                       <strong>Phone:</strong> ${placeDetails.formatted_phone_number || 'N/A'}<br>
                       <strong>Rating:</strong> ${placeDetails.rating || 'N/A'}<br>
                       <strong>Photos:</strong><br>
                           ${photos.length > 0 ? photos.map(photo => {
                    // Assuming you have a valid PlacesService instance
                    const photoUrl = photo.getUrl({ maxWidth: 400, maxHeight: 400 });
                    return `
                                   <img src="${photoUrl}" alt="Photo of ${placeDetails.name}" style="width: 100%; max-width: 150px; height: auto; margin-bottom: 10px;" onerror="this.style.display='none';">
                               `;
                }).join('') : 'No photos available.'}<br>

                       <strong>Reviews:</strong><br>
                       ${placeDetails.reviews ? placeDetails.reviews.map(review => `
                           <div>
                               <strong>${review.author_name}</strong><br>
                               Rating: ${review.rating}<br>
                               ${review.text}<br><br>
                           </div>
                       `).join('') : 'No reviews available.'}
                   `;

                    // Show the sidebar
                    //document.getElementById('sidebar').style.display = 'block';
                document.getElementById('restaurant-info').style.display = 'block';
                document.getElementById('restaurant-info').style.width = '30%';
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('map').style.width = '70%';
                document.getElementById('get-directions-btn').style.display = 'block';
            });
        });

        restaurantList.appendChild(restaurantItem);
        document.getElementById('sidebar').style.display = 'block';
    }

    // Function to clear markers from the map
    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
    }

    // Function to clear sidebar content
    function clearSidebar() {
        document.getElementById('restaurant-list').innerHTML = `
        <p>Search for restaurants or cuisines in the search bar. Results will appear here!</p>
    `;
    }
    
    
    function clearInfo() {
        document.getElementById('info').innerHTML = '';
    }
    function clearDirections() {
        if (directionsRenderer) {
            directionsRenderer.setMap(null);
            directionsRenderer = null;
        }
    }
    function back() {
        document.getElementById("sidebar").style.width = '30%';
        document.getElementById("restaurant-info").style.width = '0%';
        document.getElementById("info").innerHTML = '';
    }
</script>

</body>
</html>
